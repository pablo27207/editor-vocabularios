{% extends 'base.html' %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold mt-2 text-slate-800 dark:text-white">{{ _('Gestión de Usuarios') }}</h1>
    <p class="text-gray-600 dark:text-gray-400">{{ _('Administra roles y permisos de usuarios.') }}</p>
    <a href="{{ url_for('admin.dashboard') }}" class="text-blue-600 dark:text-blue-400 hover:underline text-sm">
        ← {{ _('Volver al panel de administración') }}
    </a>
</div>

{% with messages = get_flashed_messages() %}
{% if messages %}
<div class="alert-success mb-4">
    {% for message in messages %}
    <p>{{ message }}</p>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<div class="panel-container">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
        <thead class="bg-gray-50 dark:bg-neutral-900">
            <tr>
                <th class="table-header-cell">{{ _('Email') }}</th>
                <th class="table-header-cell">{{ _('Nombre') }}</th>
                <th class="table-header-cell">{{ _('Organización') }}</th>
                <th class="table-header-cell">{{ _('Rol Actual') }}</th>
                <th class="table-header-cell">{{ _('Registrado') }}</th>
                <th class="table-header-cell">{{ _('Acciones') }}</th>
            </tr>
        </thead>
        <tbody class="bg-white dark:bg-neutral-800 divide-y divide-gray-200 dark:divide-neutral-700">
            {% for user in users %}
            <tr>
                <td class="table-cell text-gray-900 dark:text-gray-100 font-medium">
                    {{ user.email }}
                </td>
                <td class="table-cell">
                    {{ user.name }} {{ user.last_name or '' }}
                </td>
                <td class="table-cell">
                    {{ user.organization or '-' }}
                </td>
                <td class="table-cell">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if user.role == 'admin' %}
                        bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200
                        {% elif user.role == 'reviewer' %}
                        bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                        {% elif user.role == 'editor' %}
                        bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                        {% else %}
                        bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200
                        {% endif %}
                    ">
                        {{ user.role }}
                    </span>
                </td>
                <td class="table-cell">
                    {{ user.created_at.strftime('%Y-%m-%d') }}
                </td>
                <td class="table-cell">
                    <form action="{{ url_for('admin.update_user_role', user_id=user.id) }}" method="POST"
                        class="flex items-center gap-4">
                        <select name="role" class="form-input py-1 px-2 text-sm w-28" {% if
                            user.id==session.get('user_id') %}disabled{% endif %}>
                            {% for role in valid_roles %}
                            <option value="{{ role }}" {% if user.role==role %}selected{% endif %}>
                                {{ role }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary" {% if user.id==session.get('user_id')
                            %}disabled{% endif %}>
                            {{ _('Guardar') }}
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                    {{ _('No hay usuarios registrados.') }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Create User Form -->
<div class="mt-8 p-6 bg-white dark:bg-neutral-800 rounded-sm border border-gray-200 dark:border-neutral-700 shadow-sm">
    <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200 mb-4">{{ _('Crear Nuevo Usuario') }}</h3>
    <form action="{{ url_for('admin.create_user') }}" method="POST"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
            <label for="email" class="form-label">{{ _('Email') }} *</label>
            <input type="email" name="email" id="email" required class="form-input" placeholder="usuario@ejemplo.com">
        </div>
        <div>
            <label for="name" class="form-label">{{ _('Nombre') }} *</label>
            <input type="text" name="name" id="name" required class="form-input" placeholder="Juan">
        </div>
        <div>
            <label for="last_name" class="form-label">{{ _('Apellido') }}</label>
            <input type="text" name="last_name" id="last_name" class="form-input" placeholder="Pérez">
        </div>
        <div>
            <label for="organization" class="form-label">{{ _('Organización') }}</label>
            <input type="text" name="organization" id="organization" class="form-input" placeholder="INIDEP">
        </div>
        <div>
            <label for="create-password" class="form-label">{{ _('Contraseña') }} *</label>
            <div class="relative">
                <input type="password" name="password" id="create-password" required class="form-input pr-10"
                    placeholder="********" minlength="8" pattern="(?=.*[A-Z])(?=.*[\d\W]).{8,}"
                    title="Mínimo 8 caracteres, 1 mayúscula y 1 número o símbolo">
                <button type="button" onclick="togglePassword('create-password', 'create-eye-icon')"
                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none">
                    <svg id="create-eye-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
            <p class="form-text mt-1">{{ _('Mínimo 8 caracteres, 1 mayúscula, 1 número o símbolo.') }}</p>
        </div>
        <div>
            <label for="role" class="form-label">{{ _('Rol') }}</label>
            <select name="role" id="role" class="form-input">
                {% for role in valid_roles %}
                <option value="{{ role }}">{{ role }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="md:col-span-2 lg:col-span-3 flex justify-end">
            <button type="submit" class="btn btn-primary">
                {{ _('Crear Usuario') }}
            </button>
        </div>
    </form>
</div>

<div class="mt-8 p-4 bg-gray-50 dark:bg-neutral-800 rounded-sm border border-gray-200 dark:border-neutral-700">
    <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">{{ _('Descripción de Roles') }}</h3>
    <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
        <li><span class="font-medium text-purple-600 dark:text-purple-400">admin</span>: {{ _('Acceso total, gestión de
            usuarios y aprobación de cambios.') }}</li>
        <li><span class="font-medium text-blue-600 dark:text-blue-400">reviewer</span>: {{ _('Puede aprobar/rechazar
            cambios y editar términos directamente.') }}</li>
        <li><span class="font-medium text-green-600 dark:text-green-400">editor</span>: {{ _('Puede proponer cambios que
            requieren aprobación.') }}</li>
        <li><span class="font-medium text-gray-600 dark:text-gray-400">viewer</span>: {{ _('Solo puede ver vocabularios
            (rol por defecto).') }}</li>
    </ul>
</div>
{% endblock %}